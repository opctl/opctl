"use strict";(self.webpackChunkopctl=self.webpackChunkopctl||[]).push([[6262],{1060:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"run-a-go-service","title":"Run a go service","description":"We\'ll now look at an op to run a sample Go application. Please see the code at https://github.com/opctl/opctl/tree/main/examples/run-a-go-service","source":"@site/docs/run-a-go-service.md","sourceDirName":".","slug":"/run-a-go-service","permalink":"/docs/run-a-go-service","draft":false,"unlisted":false,"editUrl":"https://github.com/opctl/opctl/edit/main/website/docs/run-a-go-service.md","tags":[],"version":"current","lastUpdatedBy":"Chris Dostert","lastUpdatedAt":1730760746000,"frontMatter":{"title":"Run a go service","sidebar_label":"run a go service"}}');var s=t(4848),r=t(8453);const o={title:"Run a go service",sidebar_label:"run a go service"},i=void 0,l={},c=[{value:"mysql",id:"mysql",level:4},{value:"dev",id:"dev",level:4}];function d(e){const n={a:"a",code:"code",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["We'll now look at an op to run a sample Go application. Please see the code at ",(0,s.jsx)(n.a,{href:"https://github.com/opctl/opctl/tree/main/examples/run-a-go-service",children:"https://github.com/opctl/opctl/tree/main/examples/run-a-go-service"}),"\nThe sample application we have requires a mysql database, therefore to run it locally we need to:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Start a MySQL database with some DB credentials"}),"\n",(0,s.jsx)(n.li,{children:"Seed the DB with sample data"}),"\n",(0,s.jsx)(n.li,{children:"Start the application and provide the MySQL DB credentials as inputs - our application will read those from environment variables"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The ops to make that happen are explained below."}),"\n",(0,s.jsx)(n.h4,{id:"mysql",children:"mysql"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"name: mysql\ndescription: runs a mysql container, seeding it with sample data\ninputs:\n  MYSQL_USER:\n    description: username for MySQL user to create\n    string:\n      default: testuser\n  MYSQL_PASSWORD:\n    description: password for MySQL user to create\n    string:\n      default: testpassword\n  MYSQL_DATABASE:\n    description: name of mysql database to create\n    string:\n      default: testapp\n  MYSQL_HOST:\n    string:\n      default: run-a-go-service-mysql\nrun:\n  container:\n    dirs:\n      # mount our data seed scripts\n      /docker-entrypoint-initdb.d:\n    image:\n      ref: 'mysql:8'\n    # this sets an opctl overlay network DNS A record so the containers available via this name.\n    name: run-a-go-service-mysql\n    envVars:\n      MYSQL_USER:\n      MYSQL_PASSWORD:\n      MYSQL_DATABASE:\n      MYSQL_RANDOM_ROOT_PASSWORD: \"yes\"\n"})}),"\n",(0,s.jsx)(n.p,{children:"This op will run a MySQL database in a Docker container and seeds the MySQL database with a single table and a single row of data."}),"\n",(0,s.jsxs)(n.p,{children:["Note that instead of writing the ",(0,s.jsx)(n.code,{children:"cmd"})," inline, we could have also put the run script in a file in the op directory and referenced it.\ne.g."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'cmd: ["/run.sh"]\n'})}),"\n",(0,s.jsx)(n.p,{children:"This becomes useful for readability if the script we're running in a container is large."}),"\n",(0,s.jsx)(n.p,{children:"Note that while we could have also built a custom docker image that contains that script and ran it, that's not a recommended practice. While the op remains portable with that approach, it is less transparent and harder to maintain, since we would have the extra step of building and pushing that image whenever we make a change to the script. Instead, we usually opt for the leanest Docker image that fulfills our use case, and include any scripts or binaries we need in the op directory."}),"\n",(0,s.jsx)(n.h4,{id:"dev",children:"dev"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"name: dev\ndescription: runs go-svc for development\ninputs:\n  MYSQL_USER:\n    description: username for MySQL user to create\n    string:\n      default: testuser\n  MYSQL_PASSWORD:\n    description: password for MySQL user to create\n    string:\n      default: testpassword\n  MYSQL_DATABASE:\n    description: Database to create\n    string:\n      default: testapp\n  MYSQL_HOST:\n    string:\n      default: mysql # the host for mysql is the container name in the mysql op\nrun:\n  parallel:\n    - op:\n        ref: $(../mysql) # we reference the mysql op using its relative path to this op\n        inputs:\n          # we pass the relevant inputs through to the mysql op\n          MYSQL_USER:\n          MYSQL_PASSWORD:\n          MYSQL_HOST:\n          MYSQL_DATABASE:\n    - container:\n        image:\n          ref: 'golang:1.23'\n        name: go-svc\n        dirs:\n          # mount the source code of our app to the container\n          /src: $(../..) \n        envVars:\n          # let our code know how to connect to the DB\n          MYSQL_USER:\n          MYSQL_PASSWORD:\n          MYSQL_HOST:\n          MYSQL_DATABASE:\n        # this sets an opctl DNS A record so the containers available via this name.\n        name: run-a-go-service-api\n        workDir: /src\n        cmd:\n          - sh\n          - -ce\n          - |\n            go get -u github.com/cespare/reflex # get reflex to watch and hot-reload our main.go\n            sleep 30 # we'll sleep while the MySQL DB starts\n            /go/bin/reflex -g 'main.go' -s -- sh -c 'go run main.go'\n"})}),"\n",(0,s.jsx)(n.p,{children:"This op will do the following, in parallel:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Run the mysql op, passing in the inputs needed to create it"}),"\n",(0,s.jsxs)(n.li,{children:["run our service in the ",(0,s.jsx)(n.code,{children:"golang"})," container. We'll use ",(0,s.jsx)(n.a,{href:"https://github.com/cespare/reflex",children:"reflex"})," to make development easier and avoid having to restart the whole operation after every change to main.go"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Now to run the service locally, we only run ",(0,s.jsx)(n.code,{children:"opctl run dev"})]}),"\n",(0,s.jsxs)(n.p,{children:["Notice how we can run ops in a ",(0,s.jsx)(n.code,{children:"parallel"})," block. Our app runs parallel to the MySQL DB container (via the ",(0,s.jsx)(n.code,{children:"mysql"})," op), because we need mysql running while our app runs."]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var a=t(6540);const s={},r=a.createContext(s);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);